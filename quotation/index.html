<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cotización | CiaoCiao.mx – Joyería Fina</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet" />
    <link rel="manifest" href="../manifest.webmanifest" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
      :root{ --bg:#f8f7f3; --paper:#fffdfa; --ink:#1f2937; --muted:#6b7280; --gold-1:#bfa36f; --gold-2:#d9c08c; --gold-3:#a98e5b; --line:#e7e3d9; --error:#dc2626; --success:#16a34a; }
      html,body{ height:100%; }
      body{ margin:0; background:var(--bg); color:var(--ink); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif; line-height:1.45; }
      .sheet{ max-width:900px; margin:40px auto; padding:28px; position:relative; background:linear-gradient(#fffefa,#fffdf7); border-radius:18px; box-shadow:0 24px 60px rgba(0,0,0,.08), 0 4px 16px rgba(0,0,0,.05); }
      .gilded-frame{ position:relative; padding:28px; border-radius:14px; background:linear-gradient(var(--paper),var(--paper)) padding-box, linear-gradient(145deg,var(--gold-2),var(--gold-1),var(--gold-3)) border-box; border:2px solid transparent; }
      .btn-back{ position:absolute; top:20px; left:20px; padding:10px 20px; background:linear-gradient(180deg,var(--gold-2),var(--gold-1)); border:1px solid var(--gold-3); border-radius:12px; color:#664f22; font-weight:600; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:8px; z-index:100; box-shadow:0 4px 10px rgba(191,163,111,.25); transition:all .3s ease; }
      .btn-back:hover{ transform:translateY(-2px); box-shadow:0 6px 16px rgba(191,163,111,.35); }
      .header{ display:grid; grid-template-columns:160px 1fr 210px; gap:20px; align-items:center; margin-bottom:20px; }
      .brand img{ width:160px; height:auto; display:block; filter:saturate(1.05) contrast(1.04); }
      .doc-title{ text-align:center; }
      .doc-title h1{ margin:0; font-family:"Playfair Display",serif; font-size:34px; letter-spacing:.06em; background:linear-gradient(120deg,var(--gold-1),var(--gold-2) 45%,var(--gold-3)); -webkit-background-clip:text; background-clip:text; color:transparent; }
      body.exporting .doc-title h1{ background:none; -webkit-background-clip:initial; background-clip:initial; color: #1f2937; }
      .doc-sub{ font-size:12px; color:var(--muted); letter-spacing:.16em; margin-top:6px; text-transform:uppercase; }
      .meta{ justify-self:end; border-left:1px solid var(--line); padding-left:16px; }
      .meta .row{ display:flex; justify-content:space-between; gap:16px; font-size:12px; color:var(--muted); margin-bottom:4px; }
      .meta .value{ font-weight:600; color:var(--ink); }
      .section{ margin-top:26px; }
      .two-col{ display:grid; grid-template-columns:1fr 1fr; gap:20px; }
      .card{ background:var(--paper); border:1px solid var(--line); border-radius:14px; padding:16px 18px; }
      .card h3{ margin:0 0 10px; font-family:"Playfair Display",serif; font-weight:700; font-size:16px; letter-spacing:.04em; }
      .field{ display:grid; grid-template-columns:140px 1fr; gap:14px; padding:6px 0; border-bottom:1px dashed #eae6dc; }
      .field:last-child{ border-bottom:0; }
      .label{ color:var(--muted); font-size:12px; letter-spacing:.08em; text-transform:uppercase; }
      .value{ font-weight:600; }
      table{ width:100%; border-collapse:collapse; }
      .items{ overflow:hidden; border:1px solid var(--line); border-radius:14px; background:var(--paper); }
      .items thead th{ font-size:12px; letter-spacing:.12em; color:var(--muted); text-transform:uppercase; text-align:left; background:linear-gradient(180deg,#fffdf6,#faf6eb); border-bottom:1px solid var(--line); padding:12px 14px; }
      .items tbody td{ padding:12px 14px; border-bottom:1px dashed #efe9dd; position:relative; }
      .items tbody tr:last-child td{ border-bottom:none; }
      .items tbody tr:hover{ background:rgba(217,192,140,0.05); }
      .right{ text-align:right; }
      .center{ text-align:center; }
      .delete-row{ position:absolute; right:-25px; top:50%; transform:translateY(-50%); width:20px; height:20px; border:1px solid var(--error); background:white; color:var(--error); border-radius:50%; cursor:pointer; display:none; align-items:center; justify-content:center; font-size:14px; line-height:1; }
      tr:hover .delete-row{ display:flex; }
      .totals{ margin-top:14px; display:grid; grid-template-columns:1fr 320px; gap:20px; align-items:start; }
      .note{ font-size:12px; color:var(--muted); }
      .sum-card{ background:var(--paper); border:1px solid var(--line); border-radius:14px; overflow:hidden; }
      .sum-card .row{ display:grid; grid-template-columns:1fr 140px; gap:10px; padding:10px 14px; border-bottom:1px dashed #efe9dd; }
      .sum-card .row:last-child{ border-bottom:none; }
      .sum-card .row.total{ background:linear-gradient(180deg,#fffdf6,#faf6eb); font-weight:700; font-size:16px; }
      .actions{ display:flex; justify-content:space-between; gap:12px; margin-top:18px; }
      .actions .btn{ padding:10px 16px; border-radius:10px; border:1px solid #d9c08c; background:linear-gradient(180deg,var(--gold-2),var(--gold-1)); color:#664f22; cursor:pointer; }
      .actions .btn.secondary{ background:#f7f5ee; border-color:#e6dcc6; color:#5b4a26; }
      .actions .btn.success{ background:#16a34a; color:white; border:none; }
      .actions .btn.primary{ background:#0b5ed7; color:white; border:none; }
      .notification{ position:fixed; top:16px; right:16px; background:#333; color:#fff; padding:10px 16px; border-radius:10px; opacity:0; transform:translateY(-8px); transition: all .25s ease; z-index:1000; }
      .notification.show{ opacity:1; transform:translateY(0); }
      .notification.success{ background:#16a34a; }
      .notification.error{ background:#dc2626; }
      .notification.info{ background:#0ea5e9; }
      .history-modal{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:1001; }
      .history-modal.active{ display:flex; }
      .history-modal-content{ background:white; color:#111; width:90%; max-width:900px; border-radius:12px; padding:20px; }
      .history-table{ width:100%; border-collapse:collapse; }
      .history-table th, .history-table td{ padding:8px 10px; border-bottom:1px solid #eee; }
      .history-modal-content h3{ margin-top:0; font-family:"Playfair Display",serif; }
      .form-label{ display:block; font-size:12px; color:var(--muted); letter-spacing:.06em; text-transform:uppercase; margin-bottom:6px; }
      .error-message{ font-size:12px; color:#dc2626; margin-top:4px; }
      .is-invalid{ border-color:#dc2626 !important; box-shadow:0 0 0 2px rgba(220,38,38,.08); }
      @media print{ body{ background:#fff; } .sheet{ margin:0; box-shadow:none; padding:0; } .actions, .btn-back{ display:none !important; } }
    </style>
  </head>
  <body>
    <script type="module" src="../src/common/security.js"></script>
    <a href="../index.html" class="btn-back">← Volver al Inicio</a>
    <div id="notification" class="notification"><span id="notification-message"></span></div>

    <div id="historyModal" class="history-modal">
      <div class="history-modal-content">
        <h3>Historial de Cotizaciones</h3>
        <div style="margin-bottom: 8px; display:grid; grid-template-columns: 1fr 1fr 2fr; gap:8px;">
          <input type="date" id="historyFrom"/>
          <input type="date" id="historyTo"/>
          <input type="text" id="searchHistory" placeholder="Buscar por cliente, número o fecha..." style="width: 100%; padding: 10px; border: 1px solid #e5e5e5; border-radius: 8px;" />
        </div>
        <div style="margin-bottom:8px; text-align:right;"><button class="btn" id="exportHistoryCsv">Exportar CSV</button></div>
        <table class="history-table">
        <thead>
          <tr>
            <th>Número</th>
            <th id="quoteHistorySortDate" style="cursor:pointer; user-select:none;">Fecha <span id="quoteHistorySortDateDir">↓</span></th>
            <th>Cliente</th>
            <th>Total</th>
            <th>Estatus</th>
            <th>Acciones</th>
          </tr>
          </thead>
          <tbody id="historyTableBody"></tbody>
        </table>
        <div style="margin-top: 20px; text-align: right;">
          <button class="btn" id="closeHistoryModal">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Modal de datos (cliente y fechas) -->
    <div id="dataModal" class="history-modal">
      <div class="history-modal-content" style="max-width:640px;">
        <h3>Datos de la cotización</h3>
        <div class="grid" style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <label>Nombre
            <input id="formClientName" type="text" placeholder="Nombre del cliente" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
          </label>
          <label>Teléfono
            <input id="formClientPhone" type="tel" placeholder="+52..." style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
          </label>
          <label>Correo
            <input id="formClientEmail" type="email" placeholder="cliente@email.com" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
          </label>
          <label>Dirección
            <input id="formClientAddress" type="text" placeholder="Dirección completa" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
          </label>
          <label>Fecha de emisión
            <input id="formIssueDate" type="date" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
          </label>
          <label>Válido hasta
            <input id="formValidUntil" type="date" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
          </label>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
          <button class="btn" id="closeDataModal">Cancelar</button>
          <button class="btn success" id="saveDataModal">Guardar</button>
        </div>
      </div>
    </div>

    <div class="sheet">
      <div class="gilded-frame">
        <div id="qrBox" style="position:absolute; right:16px; bottom:16px; width:110px; height:110px; background:#fff; border:1px solid var(--line); border-radius:8px; display:flex; align-items:center; justify-content:center;"></div>
        <header class="header">
          <div class="brand">
            <img alt="CIAO CIAO MX – Joyería Fina" src="https://i.postimg.cc/FRC6PkXn/FINE-JEWELRY-85-x-54-mm-2000-x-1200-px.png" />
          </div>
          <div class="doc-title">
            <h1>COTIZACIÓN</h1>
            <div class="doc-sub">Propuesta de precio</div>
          </div>
          <div class="meta">
            <div class="row"><span>Folio</span><span class="value" id="quoteNumber">---</span></div>
            <div class="row"><span>Estatus</span><span class="value" id="quoteStatus">pendiente</span></div>
          </div>
        </header>

        <section class="section two-col">
          <div class="card">
            <h3>Datos del Cliente</h3>
            <div class="field"><div class="label">Nombre</div><div class="value editable" contenteditable id="clientName">Nombre del Cliente</div></div>
            <div class="field"><div class="label">Teléfono</div><div class="value editable" contenteditable id="clientPhone">+52 1 55 0000 0000</div></div>
            <div class="field"><div class="label">Correo</div><div class="value editable" contenteditable id="clientEmail">cliente@email.com</div></div>
            <div class="field"><div class="label">Dirección</div><div class="value editable" contenteditable id="clientAddress">Dirección completa</div></div>
          </div>
          <div class="card">
            <h3>Fechas</h3>
            <div class="field"><div class="label">Fecha de emisión</div><div class="value" id="issueDate">---</div></div>
            <div class="field"><div class="label">Válido hasta</div><div class="value" id="validUntil">---</div></div>
          </div>
        </section>

        <section class="section">
          <div class="items">
            <table id="tabla-items">
              <thead>
                <tr>
                  <th>DESCRIPCIÓN</th>
                  <th class="center">CANT.</th>
                  <th class="right">PRECIO</th>
                  <th class="right">IMPORTE</th>
                  <th class="center">SKU/CÓDIGO</th>
                  <th class="center">ACCIONES</th>
                </tr>
              </thead>
              <tbody id="itemsBody">
                <tr>
                  <td class="editable" contenteditable>Artículo de joyería</td>
                  <td class="center editable qty" contenteditable>1</td>
                  <td class="right editable price" contenteditable>0.00</td>
                  <td class="right subtotal">0.00</td>
                  <td class="center editable" contenteditable>—</td>
                  <td class="center" style="position:relative; white-space:nowrap;">
                    <button class="delete-row" title="Eliminar" data-action="delete-row">×</button>
                    <button class="btn" style="padding:4px 6px; font-size:12px;" title="Duplicar" data-action="row-dup">⎘</button>
                    <button class="btn" style="padding:4px 6px; font-size:12px;" title="Subir" data-action="row-up">↑</button>
                    <button class="btn" style="padding:4px 6px; font-size:12px;" title="Bajar" data-action="row-down">↓</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="totals">
            <div class="note">
              <p><strong>Observaciones</strong></p>
              <p class="editable" contenteditable id="observations">Esta cotización es válida por 30 días. Los precios pueden variar según cambios en insumos.</p>
            </div>
            <div>
              <div style="display:flex; gap:8px; align-items:center; margin:0 0 8px 0;">
                <label style="font-size:12px; color:var(--muted);">Aplicar IVA
                  <input type="checkbox" id="applyIVA" style="margin-left:6px;" checked />
                </label>
                <label style="font-size:12px; color:var(--muted);">IVA (%)
                  <input type="number" id="ivaRate" value="16" min="0" max="100" step="0.1" style="width:70px; margin-left:6px; padding:6px 8px; border:1px solid var(--line); border-radius:8px;" />
                </label>
              </div>
              <div class="sum-card" id="totales">
              <div class="row"><div>Subtotal</div><div class="right" id="subtotal">0.00</div></div>
              <div class="row"><div>Descuento</div><div class="right editable" contenteditable id="descuento">0.00</div></div>
              <div class="row"><div>IVA (16%)</div><div class="right" id="iva">0.00</div></div>
              <div class="row total"><div>Total</div><div class="right" id="total">$0.00</div></div>
              </div>
            </div>
          </div>
        </section>

        <div class="actions no-print">
          <div class="actions-left">
            <button class="btn secondary" id="edit-data">✏️ Editar datos</button>
            <button class="btn secondary" id="pick-client">👤 Seleccionar cliente</button>
            <button class="btn secondary" id="add-row">➕ Agregar</button>
            <button class="btn secondary" id="open-templates">🧩 Plantillas</button>
            <button class="btn secondary" id="save-quote">💾 Guardar</button>
            <button class="btn secondary" id="new-quote">📄 Nuevo</button>
            <button class="btn secondary" id="show-history">📚 Historial</button>
          </div>
          <div class="actions-right">
            <button class="btn primary" id="share-whatsapp">📱 WhatsApp</button>
            <button class="btn success" id="generate-pdf">📥 PDF</button>
            <button class="btn" id="generate-png">🖼️ PNG</button>
            <button class="btn" id="convert-to-receipt">↪ Convertir a Recibo</button>
          </div>
        </div>

      </div>
    </div>

    <!-- Modal de plantillas de ítems -->
    <div id="templatesModal" class="history-modal">
      <div class="history-modal-content" style="max-width:800px;">
        <h3>Plantillas de ítems</h3>
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
          <input id="templatesSearch" placeholder="Buscar por descripción, SKU o tipo..." style="flex:1; padding:10px; border:1px solid #e5e5e5; border-radius:8px;"/>
        </div>
        <table class="history-table">
          <thead><tr><th>Descripción</th><th>SKU</th><th>Tipo</th><th class="right">Precio</th><th class="center">Acción</th></tr></thead>
        <tbody id="templatesTableBody"></tbody>
        </table>
        <div style="text-align:right; margin-top:12px;"><button class="btn" id="closeTemplatesModal">Cerrar</button></div>
      </div>
    </div>

    <!-- Modal de clientes recientes -->
    <div id="clientsModal" class="history-modal">
      <div class="history-modal-content" style="max-width:720px;">
        <h3>Seleccionar cliente</h3>
        <input id="clientSearch" placeholder="Buscar cliente..." style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
        <table class="history-table" style="margin-top:10px;">
          <thead><tr><th>Nombre</th><th>Teléfono</th><th>Correo</th><th>Dirección</th><th></th></tr></thead>
          <tbody id="clientsTableBody"></tbody>
        </table>
        <div style="text-align:right; margin-top:12px;"><button class="btn" id="closeClientsModal">Cerrar</button></div>
      </div>
    </div>

    <script type="module" src="../src/quotation/quote.js"></script>
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('../sw.js').catch(()=>{});
      }
    </script>
  </body>
  </html>
