<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Recibo Premium | CiaoCiao.mx – Joyería Fina</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet" />
    <link rel="manifest" href="../manifest.webmanifest" />

    <!-- jsPDF + html2canvas para exportar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.5/dist/purify.min.js"></script>

    <style>
      :root{ --bg:#f8f7f3; --paper:#fffdfa; --ink:#1f2937; --muted:#6b7280; --gold-1:#bfa36f; --gold-2:#d9c08c; --gold-3:#a98e5b; --line:#e7e3d9; --error:#dc2626; --success:#16a34a; }
      @page{ size: Letter; margin: 18mm; }
      html,body{ height:100%; }
      body{ margin:0; background:var(--bg); color:var(--ink); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, sans-serif; line-height:1.45; -webkit-text-size-adjust:100%; }
      .sheet{ max-width:900px; margin:40px auto; padding:28px; position:relative; background:linear-gradient(#fffefa,#fffdf7); border-radius:18px; box-shadow:0 24px 60px rgba(0,0,0,.08), 0 4px 16px rgba(0,0,0,.05); overflow:hidden; }
      .gilded-frame{ position:relative; padding:28px; border-radius:14px; background:linear-gradient(var(--paper),var(--paper)) padding-box, linear-gradient(145deg,var(--gold-2),var(--gold-1),var(--gold-3)) border-box; border:2px solid transparent; }
      .btn-back{ position:absolute; top:20px; left:20px; padding:10px 20px; background:linear-gradient(180deg,var(--gold-2),var(--gold-1)); border:1px solid var(--gold-3); border-radius:12px; color:#664f22; font-weight:600; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:8px; z-index:100; box-shadow:0 4px 10px rgba(191,163,111,.25); transition:all .3s ease; }
      .btn-back:hover{ transform:translateY(-2px); box-shadow:0 6px 16px rgba(191,163,111,.35); }
      .header{ display:grid; grid-template-columns:160px 1fr 210px; gap:20px; align-items:center; margin-bottom:20px; }
      .brand{ display:flex; align-items:center; gap:14px; }
      .brand img{ width:160px; height:auto; display:block; filter:saturate(1.05) contrast(1.04); }
      .brand .brand-text{ font-family:"Playfair Display",serif; font-size:14px; letter-spacing:.12em; color:var(--muted); text-transform:uppercase; }
      .doc-title{ text-align:center; }
      .doc-title h1{ margin:0; font-family:"Playfair Display",serif; font-size:34px; letter-spacing:.06em; background:linear-gradient(120deg,var(--gold-1),var(--gold-2) 45%,var(--gold-3)); -webkit-background-clip:text; background-clip:text; color:transparent; }
      body.exporting .doc-title h1{ background:none; -webkit-background-clip:initial; background-clip:initial; color: var(--ink); }
      .doc-sub{ font-size:12px; color:var(--muted); letter-spacing:.16em; margin-top:6px; text-transform:uppercase; }
      .meta{ justify-self:end; border-left:1px solid var(--line); padding-left:16px; }
      .meta .row{ display:flex; justify-content:space-between; gap:16px; font-size:12px; color:var(--muted); margin-bottom:4px; }
      .meta .value{ font-weight:600; color:var(--ink); }
      .section{ margin-top:26px; }
      .two-col{ display:grid; grid-template-columns:1fr 1fr; gap:20px; }
      .card{ background:var(--paper); border:1px solid var(--line); border-radius:14px; padding:16px 18px; }
      .card h3{ margin:0 0 12px; font-family:"Playfair Display",serif; font-weight:700; font-size:16px; letter-spacing:.06em; line-height:1.2; }
      .field{ display:grid; grid-template-columns:140px 1fr; gap:14px; padding:6px 0; border-bottom:1px dashed #eae6dc; }
      .field:last-child{ border-bottom:0; }
      .label{ color:var(--muted); font-size:12px; letter-spacing:.08em; text-transform:uppercase; }
      .value{ font-weight:600; }
      table{ width:100%; border-collapse:collapse; }
      .items{ overflow:auto; -webkit-overflow-scrolling:touch; border:1px solid var(--line); border-radius:14px; background:var(--paper); }
      .items thead th{ font-size:12px; letter-spacing:.12em; color:var(--muted); text-transform:uppercase; text-align:left; background:linear-gradient(180deg,#fffdf6,#faf6eb); border-bottom:1px solid var(--line); padding:12px 14px; }
      .items tbody td{ padding:12px 14px; border-bottom:1px dashed #efe9dd; position:relative; }
      .discount-tag{ display:none; margin-left:8px; font-size:11px; color:#dc2626; background:#fff3f3; border:1px solid #f5c2c2; border-radius:8px; padding:2px 6px; }
      body.exporting .discount-tag{ display:inline-block; }
      .items tbody tr:last-child td{ border-bottom:none; }
      .items tbody tr:hover{ background:rgba(217,192,140,0.05); }
      .items tfoot td{ padding:12px 14px; }
      .right{ text-align:right; }
      .center{ text-align:center; }
      .delete-row{ position:absolute; right:-25px; top:50%; transform:translateY(-50%); width:24px; height:24px; border:1px solid var(--error); background:white; color:var(--error); border-radius:50%; cursor:pointer; display:none; align-items:center; justify-content:center; font-size:16px; line-height:1; }
      tr:hover .delete-row{ display:flex; }
      .totals{ margin-top:14px; display:grid; grid-template-columns:1fr 320px; gap:20px; align-items:start; }
      .note{ font-size:12px; color:var(--muted); }
      .sum-card{ background:var(--paper); border:1px solid var(--line); border-radius:14px; overflow:hidden; }
      .sum-card .row{ display:grid; grid-template-columns:1fr 140px; gap:10px; padding:10px 14px; border-bottom:1px dashed #efe9dd; }
      .sum-card .row:last-child{ border-bottom:none; }
      .sum-card .row.total{ background:linear-gradient(180deg,#fffdf6,#faf6eb); font-weight:700; font-size:16px; }
      .signatures{ margin-top:26px; display:grid; grid-template-columns:1fr 1fr; gap:24px; }
      .sig{ height:140px; border:1px dashed #d8cfbd; border-radius:14px; background:#fffef8; position:relative; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; transition:all .3s ease; }
      .sig:hover{ border-color:var(--gold-1); background:#fffdf3; }
      .sig canvas{ position:absolute; top:10px; left:50%; transform:translateX(-50%); border-radius:8px; }
      .sig .label{ position:absolute; left:0; right:0; bottom:10px; text-align:center; font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.12em; }
      .sig .placeholder{ color:var(--muted); font-size:12px; opacity:.5; pointer-events:none; }
      .sig.signed .placeholder{ display:none; }
      .sig .clear-sig{ position:absolute; top:5px; right:5px; padding:4px 8px; background:var(--error); color:#fff; border:none; border-radius:6px; font-size:10px; }
      .actions{ display:flex; justify-content:space-between; gap:12px; margin-top:18px; }
      .actions .btn{ padding:10px 16px; border-radius:10px; border:1px solid var(--gold-3); background:linear-gradient(180deg,var(--gold-2),var(--gold-1)); color:#664f22; cursor:pointer; font-weight:600; }
      .actions .btn.secondary{ background:#f7f5ee; border-color:#e6dcc6; color:#5b4a26; }
      .actions .btn.success{ background:#16a34a; color:white; border: none; }
      .actions .btn.primary{ background:linear-gradient(180deg,var(--gold-2),var(--gold-1)); color:#664f22; border:1px solid var(--gold-3); }
      footer{ margin-top:20px; color:var(--muted); display:flex; gap:10px; align-items:center; justify-content:center; }
      .sep{ opacity:.6; }
      .watermark{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; font-family:"Playfair Display",serif; font-size:120px; color:rgba(0,0,0,.02); pointer-events:none; letter-spacing:.2em; }
      .notification{ position:fixed; top:16px; right:16px; background:#333; color:#fff; padding:10px 16px; border-radius:10px; opacity:0; transform:translateY(-8px); transition: all .25s ease; z-index:1000; }
      .notification.show{ opacity:1; transform:translateY(0); }
      .notification.success{ background:#16a34a; }
      .notification.error{ background:#dc2626; }
      .notification.info{ background:#0ea5e9; }
      .transaction-type-select{ padding:4px 6px; border-radius:8px; border:1px solid var(--line); }
      .qr-box{ position:absolute; right:16px; bottom:16px; width:110px; height:110px; background:#fff; border:1px solid var(--line); border-radius:8px; display:flex; align-items:center; justify-content:center; }
      .history-modal{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:2002; }
      .history-modal.active{ display:flex; }
      .history-modal-content{ background:white; color:#111; width:90%; max-width:900px; border-radius:12px; padding:20px; }
      .history-table{ width:100%; border-collapse:collapse; }
      .history-table th, .history-table td{ padding:8px 10px; border-bottom:1px solid #eee; }
      /* Modales y formularios */
      .history-modal-content h3{ margin-top: 0; font-family:"Playfair Display",serif; letter-spacing:.06em; }
      .form-label{ display:block; font-size:12px; color:var(--muted); letter-spacing:.06em; text-transform:uppercase; margin-bottom:6px; }
      .error-message{ font-size:12px; color: var(--error); margin-top:4px; }
      .is-invalid{ border-color: var(--error) !important; box-shadow: 0 0 0 2px rgba(220,38,38,0.08); }
      @media print{ body{ background:#fff; } .sheet{ margin:0; box-shadow:none; padding:0; } .actions, .watermark, .delete-row, .clear-sig, .btn-back{ display:none !important; } [contenteditable]{ background:transparent !important; padding:0 !important; margin:0 !important; } }
      @media (max-width:768px){ .btn-back{ position:static; margin-bottom:20px; } .header{ grid-template-columns:1fr; text-align:center; gap:16px; } .meta{ border-left:none; border-top:1px solid var(--line); padding:16px 0 0 0; justify-self:center; } .two-col{ grid-template-columns:1fr; } .totals{ grid-template-columns:1fr; } .signatures{ grid-template-columns:1fr; } .actions{ flex-direction:column; } .actions-left,.actions-right{ width:100%; justify-content:center; } }
      /* While any modal is open, prevent fixed bars from catching clicks */
      body.modal-open .mobile-actions, body.modal-open .mobile-summary { pointer-events: none; }
      /* Mobile floating summary + fixed actions */
      @media (max-width: 768px) {
        .sheet{ margin:16px auto; padding:16px; padding-bottom:120px; }
        .actions { display: none; }
        .items table{ min-width: 720px; }
        .mobile-summary { position: fixed; bottom: calc(64px + env(safe-area-inset-bottom)); left: 0; right: 0; padding: 10px 14px; background: rgba(255,255,255,0.98); backdrop-filter: saturate(180%) blur(6px); border-top: 1px solid var(--line); display: flex; justify-content: space-between; gap: 12px; z-index: 1000; }
        .mobile-summary .item { font-size: 14px; }
        .mobile-summary .item strong { font-size: 15px; }
        .mobile-actions { position: fixed; bottom: env(safe-area-inset-bottom); left: 0; right: 0; background: linear-gradient(180deg, var(--gold-2), var(--gold-1)); border-top: 1px solid var(--gold-3); display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; padding: 8px; z-index: 1001; }
        .mobile-actions button { padding: 12px 10px; min-height:44px; border-radius: 10px; border: 1px solid #a98e5b; background: #fff; color: #5b4a26; font-weight: 600; }
      }
      /* Template simple */
      body.simple .gilded-frame{ background: var(--paper); border:1px solid var(--line); }
      body.simple .doc-title h1{ background: none; color: var(--ink); }
      body.simple .items thead th{ background: #fafafa; }
      body.simple .sum-card .row.total{ background:#fafafa; }
    </style>
  </head>
  <body>
    <script type="module" src="../src/common/security.js"></script>
    <script type="module" src="../src/common/security.js"></script>
    <a href="../index.html" class="btn-back">← Volver al Inicio</a>

    <div id="notification" class="notification"><span id="notification-message"></span></div>

    <div id="signatureModal" class="history-modal">
      <div class="history-modal-content" style="max-width:560px;">
        <h3 id="signatureTitle">Firma</h3>
        <div style="padding:10px 0; display:flex; justify-content:center;">
          <canvas id="signatureCanvas" width="450" height="200" style="border:1px solid #eee; border-radius:8px;"></canvas>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end;">
          <button class="btn secondary" id="clearModalSignature">Limpiar</button>
          <button class="btn" id="closeSignatureModal">Cancelar</button>
          <button class="btn success" id="saveSignature">Guardar Firma</button>
        </div>
      </div>
    </div>

    <div id="historyModal" class="history-modal">
      <div class="history-modal-content">
        <h3>Historial de Recibos</h3>
        <div style="margin-bottom: 8px; display:grid; grid-template-columns: 1fr 1fr 2fr; gap:8px;">
          <input type="date" id="historyFrom"/>
          <input type="date" id="historyTo"/>
          <input type="text" id="searchHistory" placeholder="Buscar por cliente, número o fecha..." style="width: 100%; padding: 10px; border: 1px solid #e5e5e5; border-radius: 8px;" />
        </div>
        <div style="margin-bottom:8px; text-align:right;"><button class="btn" id="exportHistoryCsv">Exportar CSV</button></div>
        <table class="history-table">
        <thead>
          <tr>
            <th>Número</th>
            <th id="historySortDate" style="cursor:pointer; user-select:none;">Fecha <span id="historySortDateDir">↓</span></th>
            <th>Cliente</th>
            <th>Total</th>
            <th>Tipo</th>
            <th>Acciones</th>
          </tr>
          </thead>
          <tbody id="historyTableBody"></tbody>
        </table>
        <div style="margin-top: 20px; text-align: right;">
          <button class="btn" id="closeHistoryModal">Cerrar</button>
        </div>
      </div>
    </div>

    <!-- Modal de datos (cliente y fechas) -->
    <div id="dataModal" class="history-modal">
      <div class="history-modal-content" style="max-width:640px;">
        <h3>Datos del recibo</h3>
        <div class="grid" style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <label>Nombre
            <input id="formClientName" type="text" placeholder="Nombre del cliente" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
          </label>
          <label>Teléfono
            <input id="formClientPhone" type="tel" placeholder="+52..." style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
          </label>
          <label>Correo
            <input id="formClientEmail" type="email" placeholder="cliente@email.com" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
          </label>
          <label>Dirección
            <input id="formClientAddress" type="text" placeholder="Dirección completa" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
          </label>
          <label>Fecha de emisión
            <input id="formIssueDate" type="date" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
          </label>
          <label>Fecha de entrega
            <input id="formDeliveryDate" type="date" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
          </label>
          <label>Válido hasta
            <input id="formValidUntil" type="date" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
          </label>
        </div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="btn secondary" id="dateTodayBtn">Hoy</button>
          <button class="btn secondary" id="datePlus7Btn">Entrega +7 días</button>
          <button class="btn secondary" id="datePlus30Btn">Válido +30 días</button>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
          <button class="btn" id="closeDataModal">Cancelar</button>
          <button class="btn success" id="saveDataModal">Guardar</button>
        </div>
      </div>
    </div>

    <!-- Modal de item rápido -->
    <div id="itemModal" class="history-modal">
      <div class="history-modal-content" style="max-width:560px;">
        <h3>Agregar producto/servicio</h3>
        <div class="grid" style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <label>Descripción
            <input id="formItemDesc" type="text" placeholder="Descripción" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
          </label>
          <label>SKU/Código
            <input id="formItemSku" type="text" placeholder="SKU/Código" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
          </label>
          <label>Cantidad
            <input id="formItemQty" type="number" inputmode="numeric" step="1" min="1" value="1" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
          </label>
          <label>Precio unitario
            <input id="formItemPrice" type="number" inputmode="decimal" step="0.01" value="0.00" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
          </label>
          <label>Tipo
            <select id="formItemType" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;">
              <option value="producto" selected>Producto</option>
              <option value="servicio">Servicio</option>
              <option value="reparacion">Reparación</option>
            </select>
          </label>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:12px;">
          <button class="btn" id="closeItemModal">Cancelar</button>
          <button class="btn success" id="saveItemModal">Agregar</button>
        </div>
      </div>
    </div>

    <div class="sheet">
      <div class="watermark">CIAO CIAO MX</div>
      <div class="gilded-frame">
        <div id="qrBox" class="qr-box"></div>
        <button id="copyQrLink" class="btn" style="position:absolute; right:16px; bottom:132px; padding:6px 8px; font-size:12px;">Copiar enlace</button>
        <header class="header">
          <div class="brand">
            <img alt="CIAO CIAO MX – Joyería Fina" src="../assets/logo.png" />
          </div>
          <div class="doc-title">
            <h1>RECIBO</h1>
            <div class="doc-sub">Documento de entrega</div>
          </div>
          <div class="meta">
            <div class="row"><span>Folio</span><span class="value" id="receiptNumber">---</span></div>
            <div class="row">
              <span>Tipo</span>
              <select id="transactionType" class="transaction-type-select">
                <option value="venta">Venta</option>
                <option value="apartado">Apartado</option>
                <option value="reparacion">Reparación</option>
                <option value="consignacion">Consignación</option>
              </select>
            </div>
            <div class="row">
              <span>Método</span>
              <select id="paymentMethod" class="transaction-type-select">
                <option value="efectivo">Efectivo</option>
                <option value="tarjeta">Tarjeta</option>
                <option value="transferencia">Transferencia</option>
                <option value="mixto">Mixto</option>
              </select>
            </div>
          </div>
        </header>

        <section class="section two-col">
          <div class="card">
            <h3>Datos del Cliente</h3>
            <div class="field"><div class="label">Nombre</div><div class="value editable" contenteditable id="clientName">Nombre del Cliente</div></div>
            <div class="field"><div class="label">Teléfono</div><div class="value editable" contenteditable id="clientPhone">+52 1 55 0000 0000</div></div>
            <div class="field"><div class="label">Correo</div><div class="value editable" contenteditable id="clientEmail">cliente@email.com</div></div>
            <div class="field"><div class="label">Dirección</div><div class="value editable" contenteditable id="clientAddress">Dirección completa</div></div>
          </div>
          <div class="card">
            <h3>Fechas</h3>
            <div class="field"><div class="label">Fecha de emisión</div><div class="value" id="issueDate">---</div></div>
            <div class="field"><div class="label">Fecha de entrega</div><div class="value" id="deliveryDate">---</div></div>
            <div class="field"><div class="label">Válido hasta</div><div class="value" id="validUntil">---</div></div>
          </div>
        </section>

        <section class="section">
          <div class="items">
            <table id="tabla-items">
              <thead>
                <tr>
                  <th>DESCRIPCIÓN</th>
                  <th class="center">CANT.</th>
                  <th class="right">PRECIO</th>
                  <th class="right">DESC.</th>
                  <th class="right">IMPORTE</th>
                  <th class="center">SKU/CÓDIGO</th>
                  <th class="center">TIPO</th>
                  <th class="center">ACCIONES</th>
                </tr>
              </thead>
              <tbody id="itemsBody">
                <tr>
                  <td class="editable" contenteditable>Artículo de joyería</td>
                  <td class="center editable qty" contenteditable>1</td>
                  <td class="right editable price" contenteditable>0.00</td>
                  <td class="right editable line-discount" contenteditable>0</td>
                  <td class="right subtotal">0.00</td>
                  <td class="center editable" contenteditable>—</td>
                  <td class="center">
                    <select class="transaction-type-select item-type" style="font-size:11px; padding:4px;">
                      <option value="producto">Producto</option>
                      <option value="servicio">Servicio</option>
                      <option value="reparacion">Reparación</option>
                    </select>
                  </td>
                  <td class="center" style="position:relative; white-space:nowrap;">
                    <button class="delete-row" title="Eliminar" data-action="delete-row">×</button>
                    <button class="btn" style="padding:4px 6px; font-size:12px;" title="Duplicar" data-action="row-dup">⎘</button>
                    <button class="btn" style="padding:4px 6px; font-size:12px;" title="Subir" data-action="row-up">↑</button>
                    <button class="btn" style="padding:4px 6px; font-size:12px;" title="Bajar" data-action="row-down">↓</button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="totals">
            <div class="note">
              <p><strong>Observaciones</strong></p>
              <p class="editable" contenteditable id="observations">Joyas inspeccionadas y entregadas en perfecto estado. Se recomienda evitar contacto con químicos. Servicio de ajuste/limpieza disponible.</p>
              <p class="editable" contenteditable id="policy"><strong>Política:</strong> Garantía de por vida en mano de obra. Cambios sólo por defecto de fabricación dentro de 7 días.</p>
            </div>
            <div>
              <div style="display:flex; gap:8px; align-items:center; margin:0 0 8px 0;">
                <label style="font-size:12px; color:var(--muted);">Aplicar IVA
                  <input type="checkbox" id="applyIVA" style="margin-left:6px;" checked />
                </label>
                <label style="font-size:12px; color:var(--muted);">IVA (%)
                  <input type="number" inputmode="decimal" id="ivaRate" value="16" min="0" max="100" step="0.1" style="width:70px; margin-left:6px; padding:6px 8px; border:1px solid var(--line); border-radius:8px;" />
                </label>
              </div>
              <div class="sum-card" id="totales">
                <div class="row"><div>Subtotal</div><div class="right" id="subtotal">0.00</div></div>
                <div class="row"><div>Desc. líneas</div><div class="right" id="lineDiscTotal">0.00</div></div>
                <div class="row"><div>Descuento</div><div class="right editable" contenteditable id="descuento">0.00</div></div>
                <div class="row"><div>Aportación</div><div class="right editable" contenteditable id="aportacion">0.00</div></div>
                <div class="row"><div>IVA (16%)</div><div class="right" id="iva">0.00</div></div>
                <div class="row"><div>Anticipo</div><div class="right editable" contenteditable id="anticipo">0.00</div></div>
                <div class="row total"><div>Total</div><div class="right" id="total">$0.00</div></div>
                <div class="row" style="background:#f0fdf4;"><div>Saldo Pendiente</div><div class="right" id="saldo" style="color:var(--success); font-weight:700;">$0.00</div></div>
              </div>
            </div>
          </div>
        </section>

        <section class="section signatures">
          <div class="sig" id="clientSignature" data-signature="client">
            <span class="placeholder">Click para firmar</span>
            <canvas id="clientSigCanvas" width="280" height="100" style="display:none;"></canvas>
            <button class="clear-sig" data-action="clear-signature" data-type="client">Limpiar</button>
            <div class="label">Firma del cliente</div>
          </div>
          <div class="sig" id="companySignature" data-signature="company">
            <span class="placeholder">Click para firmar</span>
            <canvas id="companySigCanvas" width="280" height="100" style="display:none;"></canvas>
            <button class="clear-sig" data-action="clear-signature" data-type="company">Limpiar</button>
            <div class="label">Firma del responsable</div>
          </div>
        </section>

        <section class="section">
          <div class="card">
            <h3>Datos de la Joyería</h3>
            <div class="field"><div class="label">Nombre</div><div class="value">CIAO CIAO MX – Joyería Fina</div></div>
            <div class="field"><div class="label">Web</div><div class="value">www.ciaociao.mx</div></div>
            <div class="field"><div class="label">WhatsApp</div><div class="value">+52 1 55 9211 2643</div></div>
            <div class="field"><div class="label">Correo</div><div class="value">info@ciaociao.mx</div></div>
          </div>
        </section>

        <div class="actions no-print">
          <div class="actions-left">
            <button class="btn secondary" id="edit-data">✏️ Editar datos</button>
            <button class="btn secondary" id="pick-client" type="button" onclick="(function(){var m=document.getElementById('clientsModal'); if(m){m.classList.add('active'); document.body.classList.add('modal-open');}})()">👤 Seleccionar cliente</button>
            <button class="btn secondary" id="add-row">➕ Agregar</button>
            <button class="btn secondary" id="add-item-form">➕ Agregar (form)</button>
            <button class="btn secondary" id="open-templates">🧩 Plantillas</button>
            <button class="btn secondary" id="save-receipt">💾 Guardar</button>
            <button class="btn secondary" id="new-receipt">📄 Nuevo</button>
            <button class="btn secondary" id="show-history">📚 Historial</button>
            <button class="btn secondary" id="openSettings" type="button" onclick="(function(){var m=document.getElementById('settingsModal'); if(m){m.classList.add('active'); document.body.classList.add('modal-open');}})()">⚙️ Ajustes</button>
          </div>
          <div class="actions-right">
            <button class="btn primary" id="share-whatsapp">📱 WhatsApp</button>
            <button class="btn success" id="generate-pdf">📥 PDF</button>
            <button class="btn" id="generate-png">🖼️ PNG</button>
            <button class="btn" id="open-ticket">🧾 Ticket</button>
            <button class="btn" onclick="window.print()">🖨️ Imprimir</button>
          </div>
        </div>

      <footer>
        <span>© <span id="year"></span> CIAO CIAO MX</span><span class="sep">•</span>
        <span>Joyería Fina</span>
      </footer>
      </div>
    </div>

    <!-- Mobile UI -->
    <div class="mobile-summary" id="mobileSummary" style="display:none;">
      <div class="item">Subtotal: <strong id="msSubtotal">$0.00</strong></div>
      <div class="item">Total: <strong id="msTotal">$0.00</strong></div>
      <div class="item">Saldo: <strong id="msSaldo">$0.00</strong></div>
    </div>

    <!-- Modal de plantillas de ítems -->
    <div id="templatesModal" class="history-modal">
      <div class="history-modal-content" style="max-width:800px;">
        <h3>Plantillas de ítems</h3>
        <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
          <input id="templatesSearch" placeholder="Buscar por descripción, SKU o tipo..." style="flex:1; padding:10px; border:1px solid #e5e5e5; border-radius:8px;"/>
          <button class="btn" id="tplExport">Exportar CSV</button>
          <label class="btn" for="tplImportInput" style="cursor:pointer;">Importar CSV</label>
          <input id="tplImportInput" type="file" accept="text/csv" style="display:none;" />
        </div>
        <div style="display:grid; grid-template-columns: 2fr 1fr 1fr 1fr; gap:8px; margin:8px 0;">
          <input id="tplDesc" placeholder="Descripción" style="padding:10px; border:1px solid #e5e5e5; border-radius:8px;"/>
          <input id="tplSku" placeholder="SKU" style="padding:10px; border:1px solid #e5e5e5; border-radius:8px;"/>
          <select id="tplType" style="padding:10px; border:1px solid #e5e5e5; border-radius:8px;">
            <option value="producto">Producto</option>
            <option value="servicio">Servicio</option>
            <option value="reparacion">Reparación</option>
          </select>
          <input id="tplPrice" type="number" step="0.01" placeholder="Precio" style="padding:10px; border:1px solid #e5e5e5; border-radius:8px;"/>
        </div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-bottom:8px;">
          <button class="btn secondary" id="tplNew">Nuevo</button>
          <button class="btn success" id="tplSave">Guardar</button>
        </div>
        <table class="history-table">
          <thead><tr><th>Descripción</th><th>SKU</th><th>Tipo</th><th class="right">Precio</th><th class="center">Acciones</th></tr></thead>
          <tbody id="templatesTableBody"></tbody>
        </table>
        <div style="text-align:right; margin-top:12px;"><button class="btn" id="closeTemplatesModal" type="button">Cerrar</button></div>
      </div>
    </div>
    <div class="mobile-actions" id="mobileActions" style="display:none;">
      <button class="btn" id="ma-add" title="Agregar">➕</button>
      <button class="btn" id="ma-save" title="Guardar">💾</button>
      <button class="btn" id="ma-pdf" title="PDF">📥</button>
      <button class="btn" id="ma-png" title="PNG">🖼️</button>
      <button class="btn" id="ma-extra" title="Acción">⋯</button>
    </div>

    <!-- Modal de clientes recientes -->
    <div id="clientsModal" class="history-modal">
      <div class="history-modal-content" style="max-width:720px;">
        <h3>Seleccionar cliente</h3>
        <input id="clientSearch" placeholder="Buscar cliente..." style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
        <table class="history-table" style="margin-top:10px;">
          <thead><tr><th>Nombre</th><th>Teléfono</th><th>Correo</th><th>Dirección</th><th></th></tr></thead>
          <tbody id="clientsTableBody"></tbody>
        </table>
        <div style="text-align:right; margin-top:12px;"><button class="btn" id="closeClientsModal" type="button" onclick="(function(){var m=document.getElementById('clientsModal'); if(m){m.classList.remove('active'); document.body.classList.remove('modal-open');}})()">Cerrar</button></div>
      </div>
    </div>

    <!-- Modal de ajustes -->
    <div id="settingsModal" class="history-modal">
      <div class="history-modal-content" style="max-width:560px;">
        <h3>Ajustes</h3>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <label class="form-label">IVA por defecto (%)
            <input id="settingsIvaRate" type="number" min="0" max="100" step="0.1" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
          </label>
          <label class="form-label">Aplicar IVA por defecto
            <select id="settingsApplyIVA" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;">
              <option value="true">Sí</option>
              <option value="false">No</option>
            </select>
          </label>
          <label class="form-label">Días de validez por defecto
            <input id="settingsValidityDays" type="number" min="0" step="1" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
          </label>
          <label class="form-label">Plantilla
            <select id="settingsTemplate" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;">
              <option value="premium">Premium</option>
              <option value="simple">Simple</option>
            </select>
          </label>
          <label class="form-label">Tamaño PDF
            <select id="settingsPdfFormat" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;">
              <option value="letter">Carta (Letter)</option>
              <option value="a4">A4</option>
            </select>
          </label>
          <label class="form-label">URL verificador (opcional)
            <input id="settingsVerifyBase" type="url" placeholder="https://recibos.ciaociao.mx" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;" />
          </label>
          <label class="form-label">Redondeo por línea
            <select id="settingsLineRound" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;">
              <option value="none">Sin redondeo</option>
              <option value="0.5">A $0.50</option>
              <option value="1">A $1.00</option>
            </select>
          </label>
          <label class="form-label">Redondeo total
            <select id="settingsTotalRound" style="width:100%; padding:10px; border:1px solid #e5e5e5; border-radius:8px;">
              <option value="none">Sin redondeo</option>
              <option value="0.5">A $0.50</option>
              <option value="1">A $1.00</option>
            </select>
          </label>
        </div>
        <div style="display:flex; gap:8px; justify-content:space-between; align-items:center; margin-top:12px;">
          <div>
            <button class="btn" id="exportData">Exportar datos</button>
            <label class="btn" for="importDataInput" style="cursor:pointer;">Importar datos</label>
            <input id="importDataInput" type="file" accept="application/json" style="display:none;" />
          </div>
          <div>
            <button class="btn" id="closeSettingsModal" type="button" onclick="(function(){var m=document.getElementById('settingsModal'); if(m){m.classList.remove('active'); document.body.classList.remove('modal-open');}})()">Cancelar</button>
            <button class="btn success" id="saveSettingsModal">Guardar</button>
            <button class="btn" id="resetSettingsModal" type="button">Restaurar</button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import 'https://cdn.jsdelivr.net/gh/sittjoe/ciaociao-recibos-refactor@main/src/common/security.js';
      import 'https://cdn.jsdelivr.net/gh/sittjoe/ciaociao-recibos-refactor@main/src/receipt/receipt.js';
    </script>
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister()));
      }
      if (window.caches && caches.keys) { caches.keys().then(keys => keys.forEach(k => caches.delete(k))).catch(()=>{}); }
    </script>
  </body>
  </html>
